<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest station</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

    <link href="style.css" rel="stylesheet">

  </head>
  <body>

    <form>
      <input
        type="text"
        placeholder="e.g. WC2N 5RJ"
        name="postcode"
        id="postcode"
        required
      >
      <input type="submit" value="Find my nearest station">
    </form>

    <div id="results">
    </div>

    <script>

      'use strict';

      // Some fixed test values:
      //const postcode = 'N4 2DF';
      //const lat = 51.56515;
      //const lon = -0.10520;

      const myFormElement = document.querySelector('form');

      const myResultsElement = document.querySelector('#results');

      function handleForm() {

        const myFormData = new FormData(myFormElement);

        const myData = Object.fromEntries(myFormData);

        const postcode = myData["postcode"];

        let lat, lon;

        /*
        fetch(`https://api.tfl.gov.uk/StopPoint/Meta/StopTypes`)
          .then((response) => { 
            return response.json();
          })
          .then((response) => {
            console.log(response);
          });
        */

        /*
          StopTypes of interest?
          NaptanMetroStation
          NaptanRailStation
        */

        const radius = 1000; // metres, 200 is default
        const stopTypes = 'NaptanMetroStation,NaptanRailStation';

        fetch(`https://api.postcodes.io/postcodes/${postcode}`)
          .then((response) => {
            return response.json();
          })
          .then((response) => {
            lat = response["result"]["latitude"];
            lon = response["result"]["longitude"];
          })
          .then(() => {
            // Probably shouldn't nest like this, find a better structure.
            fetch(`https://api.tfl.gov.uk/StopPoint/?lat=${lat}&lon=${lon}&stopTypes=${stopTypes}&radius=${radius}`)
              .then((response) => {
                return response.json();
              })
              .then((response) => {
                const stopPointsArray = response["stopPoints"];
                let html = `Rail station(s) within ${radius} metres:<ul>`;
                for (const element of stopPointsArray) {
                  html += `<li>${element["commonName"]}</li>`;
                }
                html += '</ul>';
                myResultsElement.innerHTML = html;
              });
          });

      }

      myFormElement.addEventListener("submit", (event) => {
        handleForm();
        event.preventDefault();
      });

    </script>

  </body>
</html>